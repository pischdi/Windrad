<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Windrad Foto-Modus - Neuhausen/Spree</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1a5f3b 0%, #2e7d4e 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 1.3rem;
            margin-bottom: 0.3rem;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Map Section */
        .map-section {
            background: white;
            margin: 1rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #map {
            height: 400px;
            width: 100%;
        }
        
        .map-info {
            padding: 1rem;
            background: #f5f5f5;
            border-top: 2px solid #1a5f3b;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .info-item {
            background: white;
            padding: 0.8rem;
            border-radius: 6px;
            border-left: 3px solid #1a5f3b;
        }
        
        .info-item strong {
            display: block;
            color: #1a5f3b;
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
        }
        
        .info-item span {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        /* Buttons */
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #1a5f3b;
            color: white;
            box-shadow: 0 4px 12px rgba(26, 95, 59, 0.3);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        /* Camera View */
        .camera-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 1000;
            display: none;
        }
        
        .camera-view.active {
            display: block;
        }
        
        #cameraPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .camera-header {
            background: rgba(26, 95, 59, 0.95);
            color: white;
            padding: 1rem;
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }
        
        .camera-compass {
            position: absolute;
            top: 100px;
            right: 1rem;
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .compass-direction {
            font-size: 2rem;
            font-weight: bold;
            color: #1a5f3b;
        }
        
        .compass-degrees {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.2rem;
        }
        
        .direction-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(26, 95, 59, 0.95);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            pointer-events: auto;
        }
        
        .direction-arrow {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 0 1rem;
            pointer-events: auto;
        }
        
        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: #1a5f3b;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        .camera-btn-small {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 1.5rem;
        }
        
        /* Photo Result */
        .photo-result {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 1000;
            display: none;
            overflow-y: auto;
        }
        
        .photo-result.active {
            display: block;
        }
        
        .result-header {
            background: rgba(26, 95, 59, 0.95);
            color: white;
            padding: 1rem;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #resultCanvas {
            width: 100%;
            display: block;
        }
        
        .result-controls {
            padding: 1rem;
            background: rgba(0,0,0,0.9);
            display: flex;
            gap: 0.5rem;
        }
        
        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
        }
        
        .alert-info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            color: #1565c0;
        }
        
        .alert-warning {
            background: #fff3e0;
            border: 2px solid #ff9800;
            color: #e65100;
        }
        
        .alert-success {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            color: #2e7d32;
        }
        
        /* Turbine List */
        .turbine-list-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .turbine-list-item:hover {
            border-color: #1a5f3b;
            background: #f5fdf7;
        }
        
        .turbine-list-item.active {
            border-color: #1a5f3b;
            background: #e8f5e9;
        }
        
        .turbine-list-item h4 {
            color: #1a5f3b;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .turbine-list-item p {
            color: #666;
            font-size: 0.85rem;
            margin: 0.2rem 0;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a5f3b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .map-section {
                margin: 0.5rem;
            }
            
            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üå¨Ô∏è Windrad Foto-Modus</h1>
        <p>Neuhausen/Spree - Realistische Visualisierung</p>
    </div>
    
    <div class="container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 1rem;">Lade Windrad-Daten von GitHub...</p>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Map Section -->
            <div class="map-section">
                <div id="map"></div>
                
                <div class="map-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>üìç ENTFERNUNG</strong>
                            <span id="distanceDisplay">-</span>
                        </div>
                        <div class="info-item">
                            <strong>üß≠ RICHTUNG</strong>
                            <span id="directionDisplay">-</span>
                        </div>
                        <div class="info-item">
                            <strong>üå¨Ô∏è WINDRAD</strong>
                            <span id="turbineNameDisplay">-</span>
                        </div>
                        <div class="info-item">
                            <strong>üìè H√ñHE</strong>
                            <span id="heightDisplay">-</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="requestPermissionsAndStart()" id="photoBtn">
                        üì∏ Foto in diese Richtung aufnehmen
                    </button>
                </div>
            </div>
            
            <!-- Turbine Selection -->
            <div class="map-section" id="turbineSelection" style="display: none;">
                <div class="map-info">
                    <h3 style="color: #1a5f3b; margin-bottom: 1rem;">üå¨Ô∏è Windrad ausw√§hlen</h3>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                        Klicken Sie auf ein Windrad oder w√§hlen Sie aus der Liste:
                    </p>
                    <div id="turbineList"></div>
                </div>
            </div>
            
            <!-- Info Alert -->
            <div class="alert alert-info">
                <strong>üí° So funktioniert's:</strong>
                <ol style="margin-left: 1.2rem; margin-top: 0.5rem; line-height: 1.6;">
                    <li>Die Karte zeigt Ihren Standort und alle Windr√§der</li>
                    <li>Klicken Sie auf ein Windrad oder w√§hlen Sie aus der Liste</li>
                    <li>Die Sichtlinie zeigt die Foto-Richtung</li>
                    <li>Klicken Sie auf "Foto aufnehmen"</li>
                    <li>Richten Sie Kamera in die angezeigte Richtung</li>
                    <li>Foto machen - Windrad wird eingezeichnet!</li>
                </ol>
            </div>
        </div>
    </div>
    
    <!-- Camera View -->
    <div class="camera-view" id="cameraView">
        <video id="cameraPreview" autoplay playsinline></video>
        
        <div class="camera-overlay">
            <div class="camera-header">
                <h2 style="font-size: 1.1rem;">üì∏ Foto-Modus</h2>
                <p style="font-size: 0.9rem;">Richten Sie die Kamera in Richtung <strong id="targetDirection">-</strong></p>
            </div>
            
            <div class="camera-compass">
                <div class="compass-direction" id="cameraCompassDir">?</div>
                <div class="compass-degrees" id="cameraCompassDeg">Warte...</div>
            </div>
            
            <div class="direction-indicator" id="directionIndicator">
                <div class="direction-arrow" id="directionArrow">‚Üí</div>
                <div id="directionText">Drehen Sie sich nach rechts</div>
                <div id="compassDebug" style="font-size: 0.7rem; margin-top: 0.5rem; opacity: 0.7;"></div>
            </div>
            
            <div class="camera-controls">
                <button class="camera-btn camera-btn-small" onclick="closeCamera()">‚úï</button>
                <button class="camera-btn" onclick="takePhoto()">üì∑</button>
            </div>
        </div>
    </div>
    
    <!-- Photo Result -->
    <div class="photo-result" id="photoResult">
        <div class="result-header">
            <h2 style="font-size: 1.1rem;">üì∑ Ihr Foto mit Windrad</h2>
        </div>
        
        <canvas id="resultCanvas"></canvas>
        
        <div class="result-controls">
            <button class="btn btn-primary" onclick="downloadPhoto()">üíæ Foto herunterladen</button>
            <button class="btn btn-secondary" onclick="retakePhoto()">üîÑ Neues Foto</button>
        </div>
    </div>
    
    <script>
        // Config
        const CSV_URL = 'https://raw.githubusercontent.com/pischdi/Windrad/main/windraeder.csv';
        
        // State
        let allTurbines = [];
        let currentTurbine = null;
        let userLocation = null;
        let map = null;
        let userMarker = null;
        let turbineMarker = null;
        let sightLine = null;
        let cameraStream = null;
        let deviceOrientation = 0;
        let targetBearing = 0;
        let photoData = null;
        
        // Load turbines from GitHub
        async function loadTurbines() {
            try {
                const response = await fetch(CSV_URL + '?_=' + Date.now());
                if (!response.ok) throw new Error('CSV nicht gefunden');
                
                const csvText = await response.text();
                allTurbines = parseCSV(csvText);
                
                console.log('‚úÖ Windr√§der geladen:', allTurbines.length);
                return true;
            } catch (e) {
                console.error('Fehler:', e);
                return false;
            }
        }
        
        // Parse CSV
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const turbines = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split(',');
                if (parts.length >= 6) {
                    turbines.push({
                        id: parseInt(parts[0]),
                        name: parts[1],
                        hubHeight: parseFloat(parts[2]),
                        rotorDiameter: parseFloat(parts[3]),
                        lat: parseFloat(parts[4]),
                        lon: parseFloat(parts[5])
                    });
                }
            }
            
            return turbines;
        }
        
        // Get user location
        async function getUserLocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        resolve(userLocation);
                    },
                    error => reject(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }
        
        // Initialize map
        function initMap() {
            // Create map
            map = L.map('map').setView([userLocation.lat, userLocation.lon], 13);
            
            // Add OpenTopoMap layer (with elevation contours!)
            L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors, SRTM | ¬© OpenTopoMap',
                maxZoom: 17
            }).addTo(map);
            
            // User marker
            const userIcon = L.divIcon({
                html: '<div style="background: #2196f3; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                className: '',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            userMarker = L.marker([userLocation.lat, userLocation.lon], { icon: userIcon })
                .addTo(map)
                .bindPopup('üìç Ihr Standort');
            
            // Add ALL turbines to map
            allTurbines.forEach(turbine => {
                const turbineIcon = L.divIcon({
                    html: '<div style="background: #1a5f3b; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">üå¨Ô∏è</div>',
                    className: '',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const distance = calcDistance(userLocation.lat, userLocation.lon, turbine.lat, turbine.lon);
                
                const marker = L.marker([turbine.lat, turbine.lon], { icon: turbineIcon })
                    .addTo(map)
                    .bindPopup(`üå¨Ô∏è <strong>${turbine.name}</strong><br>Entfernung: ${formatDistance(distance)}<br>H√∂he: ${turbine.hubHeight}m`)
                    .on('click', () => selectTurbine(turbine));
                
                turbine.marker = marker;
            });
            
            // Select nearest turbine by default
            selectTurbine(currentTurbine);
            
            // Render turbine list
            renderTurbineList();
            
            // Show turbine selection
            document.getElementById('turbineSelection').style.display = 'block';
        }
        
        // Render turbine list
        function renderTurbineList() {
            const list = document.getElementById('turbineList');
            
            // Sort by distance
            const sorted = allTurbines.map(t => {
                const distance = calcDistance(userLocation.lat, userLocation.lon, t.lat, t.lon);
                return { turbine: t, distance: distance };
            }).sort((a, b) => a.distance - b.distance);
            
            list.innerHTML = sorted.map(item => {
                const bearing = calcBearing(userLocation.lat, userLocation.lon, item.turbine.lat, item.turbine.lon);
                const isActive = currentTurbine && currentTurbine.id === item.turbine.id;
                
                return `
                    <div class="turbine-list-item ${isActive ? 'active' : ''}" 
                         onclick='selectTurbineById(${item.turbine.id})'>
                        <h4>üå¨Ô∏è ${item.turbine.name}</h4>
                        <p>üìè ${formatDistance(item.distance)} entfernt | üß≠ ${formatDirection(bearing)}</p>
                        <p>üìä Nabenh√∂he: ${item.turbine.hubHeight}m | Rotor: ${item.turbine.rotorDiameter}m</p>
                    </div>
                `;
            }).join('');
        }
        
        // Select turbine by ID
        function selectTurbineById(id) {
            const turbine = allTurbines.find(t => t.id === id);
            if (turbine) selectTurbine(turbine);
        }
        
        // Select turbine
        function selectTurbine(turbine) {
            currentTurbine = turbine;
            
            // Remove old sight line
            if (sightLine) {
                map.removeLayer(sightLine);
            }
            
            // Draw new sight line
            sightLine = L.polyline(
                [[userLocation.lat, userLocation.lon], [currentTurbine.lat, currentTurbine.lon]],
                {
                    color: '#1a5f3b',
                    weight: 4,
                    dashArray: '10, 10',
                    opacity: 0.8
                }
            ).addTo(map);
            
            // Fit bounds to user and selected turbine
            const bounds = L.latLngBounds([userLocation.lat, userLocation.lon], [currentTurbine.lat, currentTurbine.lon]);
            map.fitBounds(bounds, { padding: [80, 80] });
            
            // Update info
            updateMapInfo();
            
            // Update list selection
            renderTurbineList();
        }
        
        // Update map info
        function updateMapInfo() {
            const distance = calcDistance(userLocation.lat, userLocation.lon, currentTurbine.lat, currentTurbine.lon);
            const bearing = calcBearing(userLocation.lat, userLocation.lon, currentTurbine.lat, currentTurbine.lon);
            targetBearing = bearing;
            
            document.getElementById('distanceDisplay').textContent = formatDistance(distance);
            document.getElementById('directionDisplay').textContent = formatDirection(bearing);
            document.getElementById('turbineNameDisplay').textContent = currentTurbine.name;
            document.getElementById('heightDisplay').textContent = currentTurbine.hubHeight + 'm';
        }
        
        // Request permissions and start camera - MUST BE CALLED DIRECTLY FROM BUTTON CLICK
        async function requestPermissionsAndStart() {
            try {
                // Request compass permission FIRST, in the direct user gesture context
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    
                    console.log('Requesting compass permission (iOS)...');
                    const permission = await DeviceOrientationEvent.requestPermission();
                    
                    if (permission !== 'granted') {
                        alert('‚ö†Ô∏è Kompass-Zugriff verweigert!\n\nOhne Kompass k√∂nnen Sie die Richtung nicht sehen.');
                        return;
                    }
                    
                    console.log('‚úÖ Compass permission granted');
                }
                
                // Now start camera
                await startCamera();
                
            } catch (error) {
                console.error('Permission error:', error);
                alert('Fehler bei Berechtigungen:\n\n' + error.message);
            }
        }
        
        // Start camera
        async function startCamera() {
            try {
                // Request camera
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                document.getElementById('cameraPreview').srcObject = cameraStream;
                document.getElementById('cameraView').classList.add('active');
                document.getElementById('targetDirection').textContent = formatDirection(targetBearing);
                
                // Register orientation listeners (permission already granted)
                if (window.DeviceOrientationEvent) {
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        // iOS - permission already granted above
                        window.addEventListener('deviceorientation', handleCameraOrientation);
                        console.log('‚úÖ Kompass OK (iOS)');
                    } else {
                        // Android
                        window.addEventListener('deviceorientationabsolute', handleCameraOrientation);
                        console.log('‚úÖ Kompass OK (Android)');
                    }
                }
                
            } catch (error) {
                console.error('Kamera-Fehler:', error);
                alert('Kamera-Zugriff verweigert!\n\n' + error.message);
            }
        }
        
        // Handle camera orientation
        function handleCameraOrientation(event) {
            // Try webkitCompassHeading first (iOS)
            if (event.webkitCompassHeading !== undefined && event.webkitCompassHeading !== null) {
                deviceOrientation = event.webkitCompassHeading;
            } 
            // Try alpha (Android and others)
            else if (event.alpha !== null && event.alpha !== undefined) {
                deviceOrientation = 360 - event.alpha;
            }
            // Fallback
            else {
                console.warn('Keine Kompass-Daten:', event);
                return;
            }
            
            // Update displays
            updateCameraCompass();
            updateDirectionIndicator();
        }
        
        // Update camera compass
        function updateCameraCompass() {
            const directions = ['N', 'NO', 'O', 'SO', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(deviceOrientation / 45) % 8;
            document.getElementById('cameraCompassDir').textContent = directions[index];
            document.getElementById('cameraCompassDeg').textContent = Math.round(deviceOrientation) + '¬∞';
        }
        
        // Update direction indicator
        function updateDirectionIndicator() {
            const diff = (targetBearing - deviceOrientation + 360) % 360;
            const indicator = document.getElementById('directionIndicator');
            const arrow = document.getElementById('directionArrow');
            const text = document.getElementById('directionText');
            const debug = document.getElementById('compassDebug');
            
            // Debug info
            debug.textContent = `Kompass: ${Math.round(deviceOrientation)}¬∞ | Ziel: ${Math.round(targetBearing)}¬∞`;
            
            if (Math.abs(diff) < 10 || Math.abs(diff) > 350) {
                // Correct direction!
                indicator.style.background = 'rgba(76, 175, 80, 0.95)';
                arrow.textContent = '‚úì';
                text.textContent = 'Perfekt! Foto jetzt aufnehmen';
            } else if (diff < 180) {
                // Turn right
                indicator.style.background = 'rgba(26, 95, 59, 0.95)';
                arrow.textContent = '‚Üí';
                text.textContent = `${Math.round(diff)}¬∞ nach rechts drehen`;
            } else {
                // Turn left
                indicator.style.background = 'rgba(26, 95, 59, 0.95)';
                arrow.textContent = '‚Üê';
                text.textContent = `${Math.round(360 - diff)}¬∞ nach links drehen`;
            }
        }
        
        // Close camera
        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Remove orientation listeners - SAME AS WORKING VERSION
            window.removeEventListener('deviceorientation', handleCameraOrientation);
            window.removeEventListener('deviceorientationabsolute', handleCameraOrientation);
            
            document.getElementById('cameraView').classList.remove('active');
        }
        
        // Take photo
        function takePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('resultCanvas');
            
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            
            // Draw video frame
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Draw windrad overlay
            drawWindradOverlay(ctx, canvas.width, canvas.height);
            
            // Save photo data
            photoData = canvas.toDataURL('image/jpeg', 0.95);
            
            // Close camera and show result
            closeCamera();
            document.getElementById('photoResult').classList.add('active');
        }
        
        // Draw windrad overlay on photo
        function drawWindradOverlay(ctx, width, height) {
            const distance = calcDistance(userLocation.lat, userLocation.lon, currentTurbine.lat, currentTurbine.lon);
            const distanceMeters = distance * 1000;
            const actualHeight = currentTurbine.hubHeight + (currentTurbine.rotorDiameter / 2);
            
            // Calculate size
            const pixelHeight = Math.max(50, Math.min(height * 0.8, (actualHeight / distanceMeters) * 500));
            
            // Position in center-bottom
            const x = width / 2;
            const y = height - 100;
            
            const towerWidth = pixelHeight * 0.05;
            const towerHeight = pixelHeight * 0.7;
            const bladeLength = pixelHeight * 0.3;
            
            // Tower
            ctx.fillStyle = 'rgba(220, 220, 220, 0.95)';
            ctx.fillRect(x - towerWidth/2, y, towerWidth, -towerHeight);
            
            // Tower outline
            ctx.strokeStyle = 'rgba(100, 100, 100, 1.0)';
            ctx.lineWidth = 3;
            ctx.strokeRect(x - towerWidth/2, y, towerWidth, -towerHeight);
            
            // Nacelle
            ctx.fillStyle = 'rgba(240, 240, 240, 0.95)';
            ctx.fillRect(x - towerWidth, y - towerHeight - 20, towerWidth * 2, 20);
            
            // Hub
            ctx.fillStyle = 'rgba(200, 200, 200, 0.95)';
            ctx.beginPath();
            ctx.arc(x, y - towerHeight - 10, 12, 0, 2 * Math.PI);
            ctx.fill();
            
            // Blades (static - not rotating in photo)
            for (let i = 0; i < 3; i++) {
                const angle = (i * 120) * Math.PI / 180;
                const bladeX = x + Math.sin(angle) * bladeLength;
                const bladeY = y - towerHeight - 10 + Math.cos(angle) * bladeLength;
                
                // Blade shadow
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.lineWidth = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - towerHeight - 10);
                ctx.lineTo(bladeX, bladeY);
                ctx.stroke();
                
                // Blade
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.95)';
                ctx.lineWidth = 10;
                ctx.beginPath();
                ctx.moveTo(x, y - towerHeight - 10);
                ctx.lineTo(bladeX, bladeY);
                ctx.stroke();
            }
            
            // Label background
            ctx.fillStyle = 'rgba(26, 95, 59, 0.95)';
            const labelWidth = 300;
            const labelHeight = 80;
            ctx.fillRect(x - labelWidth/2, y + 20, labelWidth, labelHeight);
            
            // Label text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(currentTurbine.name, x, y + 50);
            
            ctx.font = '18px Arial';
            ctx.fillText(`${formatDistance(distance)} entfernt`, x, y + 75);
            ctx.fillText(`${currentTurbine.hubHeight}m Nabenh√∂he`, x, y + 95);
        }
        
        // Download photo
        function downloadPhoto() {
            const link = document.createElement('a');
            link.download = `windrad_${currentTurbine.name}_${Date.now()}.jpg`;
            link.href = photoData;
            link.click();
        }
        
        // Retake photo
        function retakePhoto() {
            document.getElementById('photoResult').classList.remove('active');
            startCamera();
        }
        
        // Calculate distance (Haversine)
        function calcDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Calculate bearing
        function calcBearing(lat1, lon1, lat2, lon2) {
            const dLon = toRad(lon2 - lon1);
            const y = Math.sin(dLon) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                     Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
            let bearing = toDeg(Math.atan2(y, x));
            return (bearing + 360) % 360;
        }
        
        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }
        
        function formatDistance(km) {
            return km < 1 ? Math.round(km * 1000) + ' m' : km.toFixed(2) + ' km';
        }
        
        function formatDirection(bearing) {
            const dirs = ['N', 'NO', 'O', 'SO', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(bearing / 45) % 8;
            return dirs[index] + ' (' + Math.round(bearing) + '¬∞)';
        }
        
        // Initialize
        async function init() {
            // Load turbines
            const loaded = await loadTurbines();
            if (!loaded || allTurbines.length === 0) {
                document.getElementById('loadingState').innerHTML = 
                    '<div class="alert alert-warning">‚ö†Ô∏è Keine Windrad-Daten gefunden!</div>';
                return;
            }
            
            // Get location
            try {
                await getUserLocation();
            } catch (error) {
                document.getElementById('loadingState').innerHTML = 
                    '<div class="alert alert-warning">‚ö†Ô∏è GPS-Zugriff verweigert!<br><small>Bitte erlauben Sie Standortzugriff.</small></div>';
                return;
            }
            
            // Find nearest turbine
            currentTurbine = allTurbines[0];
            if (allTurbines.length > 1) {
                // Find closest
                let minDist = Infinity;
                allTurbines.forEach(t => {
                    const dist = calcDistance(userLocation.lat, userLocation.lon, t.lat, t.lon);
                    if (dist < minDist) {
                        minDist = dist;
                        currentTurbine = t;
                    }
                });
            }
            
            // Show main content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Init map
            initMap();
        }
        
        // Start on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
