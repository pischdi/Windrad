<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windrad AR Admin - Neuhausen/Spree</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
        }
        
        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a5f3b 0%, #2e7d4e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-screen.hidden {
            display: none;
        }
        
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
        }
        
        .login-box h1 {
            color: #1a5f3b;
            margin-bottom: 0.5rem;
        }
        
        .login-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .login-error {
            background: #ffebee;
            color: #c62828;
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        /* Navigation */
        .nav {
            background: #1a5f3b;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav h1 {
            font-size: 1.2rem;
        }
        
        .nav-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 0.9rem;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 0 1rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #1a5f3b;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        /* Map */
        #map {
            height: 400px;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1a5f3b;
        }
        
        /* Buttons */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #1a5f3b;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2e7d4e;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-delete {
            padding: 0.5rem 1rem;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .btn-download {
            padding: 0.8rem 1.5rem;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* List */
        .turbine-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .turbine-item {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .turbine-info {
            flex: 1;
        }
        
        .turbine-info strong {
            display: block;
            color: #1a5f3b;
            margin-bottom: 0.3rem;
        }
        
        .turbine-info small {
            color: #666;
            font-size: 0.85rem;
        }
        
        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        
        .alert-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1565c0;
        }
        
        .alert-warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #e65100;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üîê Admin-Zugang</h1>
            <p style="color: #666; margin-bottom: 1.5rem;">Windrad AR Verwaltung - Neuhausen/Spree</p>
            
            <div id="loginError" class="login-error" style="display: none;"></div>
            
            <input 
                type="password" 
                class="login-input" 
                id="passwordInput" 
                placeholder="Admin-Passwort"
                onkeypress="if(event.key==='Enter')login()"
            >
            
            <button class="btn btn-primary" onclick="login()">Anmelden</button>
            
            <p style="margin-top: 1rem; font-size: 0.85rem; color: #999;">
                Standard-Passwort: neuhausen2025<br>
                <small>(√Ñndern Sie das Passwort in Zeile 290)</small>
            </p>
        </div>
    </div>
    
    <!-- Admin View -->
    <div id="adminView" style="display: none;">
        <div class="nav">
            <div class="nav-content">
                <h1>üå¨Ô∏è Windrad AR - Admin</h1>
                <button class="nav-btn" onclick="logout()">Abmelden</button>
            </div>
        </div>
        
        <div class="container">
            <!-- Status -->
            <div class="card">
                <h2>üìä Status & Aktionen</h2>
                <p><strong>Gespeicherte Windr√§der:</strong> <span id="turbineCount">0</span></p>
                <p><strong>Repository:</strong> <span id="repoDisplay" style="font-family: monospace;">-</span></p>

                <div style="margin-top: 1rem;">
                    <button class="btn-primary" onclick="pushToGitHub()" id="pushBtn">
                        ‚úÖ Auf GitHub ver√∂ffentlichen
                    </button>
                    <button class="btn-secondary" onclick="reloadFromGitHub()" style="margin-left: 0.5rem;">
                        üîÑ Von GitHub neu laden
                    </button>
                    <button class="btn-secondary" onclick="downloadCSV()" style="margin-left: 0.5rem;">
                        üíæ CSV herunterladen (Backup)
                    </button>
                    <button class="btn-secondary" onclick="showConfig()" style="margin-left: 0.5rem;">
                        ‚öôÔ∏è Konfiguration
                    </button>
                </div>

                <div id="githubStatus" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- Configuration Modal -->
            <div id="configModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 20000; overflow-y: auto;">
                <div style="max-width: 600px; margin: 50px auto; background: white; border-radius: 12px; padding: 2rem;">
                    <h2 style="color: #1a5f3b; margin-bottom: 1rem;">‚öôÔ∏è GitHub Konfiguration</h2>

                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Sicherheitshinweis:</strong><br>
                        Der GitHub Token wird lokal im Browser gespeichert.<br>
                        Verwenden Sie einen Token mit <strong>nur</strong> Schreibrechten f√ºr dieses Repo!
                    </div>

                    <div class="form-group">
                        <label>GitHub Repository:</label>
                        <input type="text" class="form-control" id="configRepo" placeholder="username/repository">
                        <small style="color: #666;">z.B. pischdi/Windrad</small>
                    </div>

                    <div class="form-group">
                        <label>Branch:</label>
                        <input type="text" class="form-control" id="configBranch" placeholder="main">
                    </div>

                    <div class="form-group">
                        <label>CSV-Pfad:</label>
                        <input type="text" class="form-control" id="configCsvPath" placeholder="windraeder.csv">
                    </div>

                    <div class="form-group">
                        <label>GitHub Personal Access Token:</label>
                        <input type="password" class="form-control" id="configToken" placeholder="ghp_xxxxxxxxxxxx">
                        <small style="color: #666;">
                            Token erstellen: <a href="https://github.com/settings/tokens/new?scopes=repo&description=Windrad%20AR%20Admin" target="_blank">GitHub Settings</a><br>
                            Ben√∂tigte Permission: <strong>repo</strong> (oder nur <strong>public_repo</strong> f√ºr √∂ffentliche Repos)
                        </small>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <button class="btn-primary" onclick="saveConfig()">üíæ Konfiguration speichern</button>
                        <button class="btn-secondary" onclick="closeConfig()" style="margin-left: 0.5rem;">Abbrechen</button>
                    </div>
                </div>
            </div>
            
            <!-- Map -->
            <div class="card">
                <h2>üó∫Ô∏è Windrad hinzuf√ºgen</h2>
                <p>Klicken Sie auf die Karte, um einen Standort auszuw√§hlen:</p>
                <div id="map"></div>
                
                <div id="addForm" style="display: none;">
                    <!-- Tile Info -->
                    <div class="alert alert-info" id="tileInfo" style="margin-bottom: 1rem;">
                        <strong>üì¶ Ben√∂tigte H√∂hendaten-Tiles:</strong>
                        <div id="tileList" style="margin-top: 0.5rem; font-family: monospace; font-size: 0.9rem;"></div>
                    </div>

                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" class="form-control" id="turbineName" placeholder="z.B. Windpark Nord">
                    </div>

                    <div class="form-group">
                        <label>WEA-Typ (optional - zum Auto-Ausf√ºllen):</label>
                        <select class="form-control" id="turbineType" onchange="fillSpecs()">
                            <option value="">-- Manuell eingeben --</option>
                            <option value="vestas_v150">Vestas V150 (Nabenh√∂he 166m, Rotor 150m)</option>
                            <option value="nordex_n149">Nordex N149 (Nabenh√∂he 164m, Rotor 149m)</option>
                            <option value="enercon_e138">Enercon E-138 (Nabenh√∂he 160m, Rotor 138m)</option>
                            <option value="enercon_e160">Enercon E-160 (Nabenh√∂he 166m, Rotor 160m)</option>
                            <option value="siemens_sg170">Siemens SG 170 (Nabenh√∂he 165m, Rotor 170m)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Nabenh√∂he (Meter):</label>
                        <input type="number" class="form-control" id="hubHeight" placeholder="z.B. 166">
                    </div>
                    
                    <div class="form-group">
                        <label>Rotordurchmesser (Meter):</label>
                        <input type="number" class="form-control" id="rotorDiameter" placeholder="z.B. 150">
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveTurbine()">üíæ Windrad speichern</button>
                    <button class="btn btn-secondary" onclick="cancelAdd()">Abbrechen</button>
                </div>
            </div>
            
            <!-- List -->
            <div class="card">
                <h2>üìù Gespeicherte Windr√§der</h2>
                <div class="turbine-list" id="turbineList">
                    <p style="color: #666;">Noch keine Windr√§der hinzugef√ºgt.</p>
                </div>
            </div>
            
            <!-- GitHub Setup Instructions -->
            <div class="card">
                <h2>üîß Ersteinrichtung</h2>
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Einmalige Konfiguration erforderlich</strong>
                </div>
                <p style="margin-bottom: 1rem;">F√ºr direkten GitHub-Upload ben√∂tigen Sie einen Personal Access Token:</p>
                <ol style="margin-left: 1.5rem; line-height: 1.8;">
                    <li>√ñffnen Sie <a href="https://github.com/settings/tokens/new?scopes=repo&description=Windrad%20AR%20Admin" target="_blank" style="color: #2196f3;">GitHub Token Settings</a></li>
                    <li>Klicken Sie auf <strong>"Generate token"</strong></li>
                    <li>W√§hlen Sie Permissions: <strong>repo</strong> (oder nur <strong>public_repo</strong> f√ºr √∂ffentliche Repos)</li>
                    <li>Expiration: <strong>No expiration</strong> oder gew√ºnschte Dauer</li>
                    <li>Token kopieren (nur einmal sichtbar!)</li>
                    <li>Oben auf <strong>"‚öôÔ∏è Konfiguration"</strong> klicken</li>
                    <li>Repository, Branch und Token eintragen</li>
                    <li>Speichern ‚úÖ</li>
                </ol>
                <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                    <strong>Hinweis:</strong> Der Token wird lokal im Browser gespeichert.<br>
                    F√ºr andere Systeme: Konfiguration neu eintragen oder manuellen Upload nutzen (siehe unten).
                </p>
            </div>

            <!-- Manual Upload Fallback -->
            <div class="card">
                <h2>üì§ Manueller Upload (Fallback)</h2>
                <p style="margin-bottom: 1rem;">Falls automatischer Upload nicht funktioniert:</p>
                <ol style="margin-left: 1.5rem; line-height: 1.8;">
                    <li>Klicken Sie oben auf <strong>"üíæ CSV herunterladen (Backup)"</strong></li>
                    <li>√ñffnen Sie Ihr GitHub Repository</li>
                    <li>Klicken Sie auf die alte <strong>windraeder.csv</strong> Datei</li>
                    <li>Klicken Sie rechts auf das <strong>Stift-Symbol</strong> (Edit)</li>
                    <li>L√∂schen Sie den alten Inhalt</li>
                    <li>√ñffnen Sie die heruntergeladene CSV mit Editor/Notepad</li>
                    <li>Kopieren Sie den gesamten Inhalt</li>
                    <li>F√ºgen Sie ihn auf GitHub ein</li>
                    <li>Unten: <strong>"Commit changes"</strong> klicken</li>
                    <li>Fertig! Nach ~1 Minute auf allen Ger√§ten verf√ºgbar ‚úÖ</li>
                </ol>
            </div>
        </div>
    </div>
    
    <script>
        // Config
        const ADMIN_PASSWORD = 'neuhausen2025';  // √Ñndern Sie dies!
        const CSV_URL = 'https://raw.githubusercontent.com/pischdi/Windrad/main/windraeder.csv';

        // State
        let turbines = [];
        let map = null;
        let marker = null;
        let selectedLat = null;
        let selectedLon = null;
        let adminPassword = '';

        // Load from localStorage
        function loadTurbines() {
            const saved = localStorage.getItem('windrad_turbines_github');
            if (saved) {
                turbines = JSON.parse(saved);
            }
        }

        // Load from GitHub CSV
        async function loadFromGitHub() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('CSV nicht gefunden');

                const csvText = await response.text();
                const lines = csvText.trim().split('\n');

                if (lines.length < 2) {
                    console.log('CSV ist leer');
                    return;
                }

                // Parse CSV (skip header)
                turbines = [];
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',');
                    if (parts.length >= 6) {
                        turbines.push({
                            id: parseInt(parts[0]),
                            name: parts[1],
                            hubHeight: parseInt(parts[2]),
                            rotorDiameter: parseInt(parts[3]),
                            lat: parseFloat(parts[4]),
                            lon: parseFloat(parts[5])
                        });
                    }
                }

                // Save to localStorage
                saveTurbinesLocal();
                showNotification(`‚úÖ ${turbines.length} Windr√§der von GitHub geladen`, 'success');

            } catch (err) {
                console.error('GitHub load error:', err);
                showNotification('‚ö†Ô∏è Konnte GitHub CSV nicht laden - starte mit leerem Set', 'warning');
            }
        }
        
        // Save to localStorage
        function saveTurbinesLocal() {
            localStorage.setItem('windrad_turbines_github', JSON.stringify(turbines));
            renderList();
            updateCount();
        }
        
        // Reload from GitHub
        async function reloadFromGitHub() {
            if (turbines.length > 0) {
                if (!confirm('Aktuelle lokale √Ñnderungen werden √ºberschrieben. Fortfahren?')) {
                    return;
                }
            }
            await loadFromGitHub();
            renderList();
            updateCount();
        }

        // Download CSV
        function downloadCSV() {
            if (turbines.length === 0) {
                alert('Keine Windr√§der zum Exportieren!');
                return;
            }

            // Create CSV
            let csv = 'id,name,hubHeight,rotorDiameter,lat,lon\n';
            turbines.forEach(t => {
                csv += `${t.id},${t.name},${t.hubHeight},${t.rotorDiameter},${t.lat},${t.lon}\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'windraeder.csv';
            link.click();

            showNotification('‚úÖ CSV heruntergeladen! Jetzt auf GitHub hochladen.', 'success');
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'success' ? '#4caf50' : '#f44336';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Login
        function login() {
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('loginError');
            
            if (password === ADMIN_PASSWORD) {
                adminPassword = password;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminView').style.display = 'block';
                initAdmin();
            } else {
                errorEl.textContent = '‚ùå Falsches Passwort!';
                errorEl.style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }
        
        function logout() {
            if (confirm('M√∂chten Sie sich wirklich abmelden?')) {
                location.reload();
            }
        }
        
        // Init Admin
        async function initAdmin() {
            // Load data - try GitHub first, then localStorage
            await loadFromGitHub();
            if (turbines.length === 0) {
                loadTurbines();
            }
            renderList();
            updateCount();

            // Init map
            if (!map) {
                map = L.map('map').setView([51.5833, 14.2833], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
                
                map.on('click', function(e) {
                    selectedLat = e.latlng.lat;
                    selectedLon = e.latlng.lng;

                    if (marker) {
                        map.removeLayer(marker);
                    }

                    marker = L.marker([selectedLat, selectedLon], {
                        draggable: true
                    }).addTo(map);

                    marker.on('dragend', function(e) {
                        const pos = e.target.getLatLng();
                        selectedLat = pos.lat;
                        selectedLon = pos.lng;
                        updateTileInfo(selectedLat, selectedLon);
                    });

                    document.getElementById('addForm').style.display = 'block';
                    document.getElementById('turbineName').focus();
                    updateTileInfo(selectedLat, selectedLon);
                });
            }
        }
        
        // Convert WGS84 to UTM33N (EPSG:25833)
        function convertToUTM(lat, lng) {
            const a = 6378137.0;
            const k0 = 0.9996;
            const e = 0.081819190842622;

            const latRad = lat * Math.PI / 180;
            const lngRad = lng * Math.PI / 180;
            const lngOrigin = 15 * Math.PI / 180;

            const N = a / Math.sqrt(1 - e * e * Math.sin(latRad) * Math.sin(latRad));
            const T = Math.tan(latRad) * Math.tan(latRad);
            const C = e * e * Math.cos(latRad) * Math.cos(latRad) / (1 - e * e);
            const A = (lngRad - lngOrigin) * Math.cos(latRad);

            const x = k0 * N * (A + (1 - T + C) * A * A * A / 6);
            const y = k0 * N * latRad;

            return { x: 500000 + x, y: y };
        }

        // Calculate required tiles for a turbine location
        function getRequiredTiles(lat, lng, radiusKm = 5) {
            const utm = convertToUTM(lat, lng);
            const radiusM = radiusKm * 1000;

            // Calculate bounding box in UTM
            const minX = utm.x - radiusM;
            const maxX = utm.x + radiusM;
            const minY = utm.y - radiusM;
            const maxY = utm.y + radiusM;

            // Calculate tile IDs (1000m √ó 1000m tiles)
            const minTileX = Math.floor(minX / 1000);
            const maxTileX = Math.floor(maxX / 1000);
            const minTileY = Math.floor(minY / 1000);
            const maxTileY = Math.floor(maxY / 1000);

            const tiles = [];
            for (let tileX = minTileX; tileX <= maxTileX; tileX++) {
                for (let tileY = minTileY; tileY <= maxTileY; tileY++) {
                    tiles.push(`tile_${tileX}_${tileY}.bin`);
                }
            }

            return tiles;
        }

        // Update tile info display
        function updateTileInfo(lat, lng) {
            const tiles = getRequiredTiles(lat, lng, 5);
            const tileListEl = document.getElementById('tileList');

            let html = `<strong>Sichtbereich:</strong> 5 km Radius<br>`;
            html += `<strong>Ben√∂tigte Tiles:</strong> ${tiles.length}<br><br>`;
            html += tiles.join('<br>');

            tileListEl.innerHTML = html;
        }

        // Fill specs
        function fillSpecs() {
            const type = document.getElementById('turbineType').value;
            const specs = {
                'vestas_v150': { height: 166, rotor: 150 },
                'nordex_n149': { height: 164, rotor: 149 },
                'enercon_e138': { height: 160, rotor: 138 },
                'enercon_e160': { height: 166, rotor: 160 },
                'siemens_sg170': { height: 165, rotor: 170 }
            };

            if (specs[type]) {
                document.getElementById('hubHeight').value = specs[type].height;
                document.getElementById('rotorDiameter').value = specs[type].rotor;
            }
        }
        
        // Save turbine
        function saveTurbine() {
            const name = document.getElementById('turbineName').value.trim();
            const height = parseInt(document.getElementById('hubHeight').value);
            const rotor = parseInt(document.getElementById('rotorDiameter').value);
            
            if (!name || !height || !rotor) {
                alert('Bitte alle Felder ausf√ºllen!');
                return;
            }
            
            const turbine = {
                id: Date.now(),
                name: name,
                hubHeight: height,
                rotorDiameter: rotor,
                lat: selectedLat,
                lon: selectedLon
            };
            
            turbines.push(turbine);
            saveTurbinesLocal();
            
            showNotification('‚úÖ Windrad gespeichert! Vergessen Sie nicht die CSV herunterzuladen.', 'success');
            
            // Reset
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('turbineName').value = '';
            document.getElementById('turbineType').value = '';
            document.getElementById('hubHeight').value = '';
            document.getElementById('rotorDiameter').value = '';
            
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
        }
        
        function cancelAdd() {
            document.getElementById('addForm').style.display = 'none';
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
        }
        
        // Delete turbine
        function deleteTurbine(id) {
            if (confirm('Windrad wirklich l√∂schen?')) {
                turbines = turbines.filter(t => t.id !== id);
                saveTurbinesLocal();
                showNotification('üóëÔ∏è Windrad gel√∂scht!', 'success');
            }
        }
        
        // Update count
        function updateCount() {
            document.getElementById('turbineCount').textContent = turbines.length;
        }
        
        // Render list
        function renderList() {
            const list = document.getElementById('turbineList');

            if (turbines.length === 0) {
                list.innerHTML = '<p style="color: #666;">Noch keine Windr√§der hinzugef√ºgt.</p>';
                return;
            }

            list.innerHTML = turbines.map(t => `
                <div class="turbine-item">
                    <div class="turbine-info">
                        <strong>${t.name}</strong>
                        <small>Nabenh√∂he: ${t.hubHeight}m | Rotor: ${t.rotorDiameter}m | ${t.lat.toFixed(5)}, ${t.lon.toFixed(5)}</small>
                    </div>
                    <button class="btn-delete" onclick="deleteTurbine(${t.id})">L√∂schen</button>
                </div>
            `).join('');
        }

        // ==============================
        // GitHub Configuration & Upload
        // ==============================

        // Load configuration
        function loadConfig() {
            const config = {
                repo: localStorage.getItem('windrad_github_repo') || 'pischdi/Windrad',
                branch: localStorage.getItem('windrad_github_branch') || 'main',
                csvPath: localStorage.getItem('windrad_github_csvPath') || 'windraeder.csv',
                token: localStorage.getItem('windrad_github_token') || ''
            };

            // Update display
            document.getElementById('repoDisplay').textContent = config.repo;

            // Disable push button if no token
            if (!config.token) {
                document.getElementById('pushBtn').disabled = true;
                document.getElementById('pushBtn').title = 'Bitte GitHub Token in Konfiguration eintragen';
            }

            return config;
        }

        // Show configuration modal
        function showConfig() {
            const config = loadConfig();

            document.getElementById('configRepo').value = config.repo;
            document.getElementById('configBranch').value = config.branch;
            document.getElementById('configCsvPath').value = config.csvPath;
            document.getElementById('configToken').value = config.token;

            document.getElementById('configModal').style.display = 'block';
        }

        // Close configuration modal
        function closeConfig() {
            document.getElementById('configModal').style.display = 'none';
        }

        // Save configuration
        function saveConfig() {
            const repo = document.getElementById('configRepo').value.trim();
            const branch = document.getElementById('configBranch').value.trim();
            const csvPath = document.getElementById('configCsvPath').value.trim();
            const token = document.getElementById('configToken').value.trim();

            if (!repo || !branch || !csvPath) {
                alert('Bitte alle Felder ausf√ºllen!');
                return;
            }

            if (!token) {
                alert('Bitte GitHub Token eintragen! Ohne Token k√∂nnen keine Commits gemacht werden.');
                return;
            }

            // Validate token format
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                if (!confirm('Token hat ungew√∂hnliches Format. Trotzdem speichern?')) {
                    return;
                }
            }

            // Save to localStorage
            localStorage.setItem('windrad_github_repo', repo);
            localStorage.setItem('windrad_github_branch', branch);
            localStorage.setItem('windrad_github_csvPath', csvPath);
            localStorage.setItem('windrad_github_token', token);

            // Update UI
            document.getElementById('repoDisplay').textContent = repo;
            document.getElementById('pushBtn').disabled = false;

            closeConfig();
            showNotification('‚úÖ Konfiguration gespeichert!', 'success');
        }

        // Push to GitHub
        async function pushToGitHub() {
            if (turbines.length === 0) {
                alert('Keine Windr√§der zum Ver√∂ffentlichen!');
                return;
            }

            const config = loadConfig();

            if (!config.token) {
                alert('Bitte zuerst GitHub Token in Konfiguration eintragen!');
                showConfig();
                return;
            }

            const statusEl = document.getElementById('githubStatus');
            statusEl.style.display = 'block';
            statusEl.className = 'alert alert-info';
            statusEl.innerHTML = '‚è≥ Ver√∂ffentliche auf GitHub...';

            try {
                // 1. Generate CSV content
                let csvContent = 'id,name,hubHeight,rotorDiameter,lat,lon\n';
                turbines.forEach(t => {
                    csvContent += `${t.id},${t.name},${t.hubHeight},${t.rotorDiameter},${t.lat},${t.lon}\n`;
                });

                // 2. Get current file SHA (required for updating)
                const fileUrl = `https://api.github.com/repos/${config.repo}/contents/${config.csvPath}?ref=${config.branch}`;
                let sha = null;

                const fileResponse = await fetch(fileUrl, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (fileResponse.ok) {
                    const fileData = await fileResponse.json();
                    sha = fileData.sha;
                }

                // 3. Commit to GitHub
                const commitUrl = `https://api.github.com/repos/${config.repo}/contents/${config.csvPath}`;
                const commitMessage = `Update windraeder.csv (${turbines.length} Windr√§der) - via Admin Panel`;

                const commitPayload = {
                    message: commitMessage,
                    content: btoa(unescape(encodeURIComponent(csvContent))), // Base64 encode UTF-8
                    branch: config.branch
                };

                if (sha) {
                    commitPayload.sha = sha; // Update existing file
                }

                const commitResponse = await fetch(commitUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commitPayload)
                });

                if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(errorData.message || 'GitHub API Fehler');
                }

                const commitData = await commitResponse.json();

                // Success!
                statusEl.className = 'alert alert-success';
                statusEl.innerHTML = `
                    ‚úÖ <strong>Erfolgreich ver√∂ffentlicht!</strong><br>
                    <small>
                        Commit: <a href="${commitData.commit.html_url}" target="_blank" style="color: #2e7d32;">${commitData.commit.sha.substring(0, 7)}</a><br>
                        Die √Ñnderungen sind in ~1 Minute live auf GitHub Pages verf√ºgbar.
                    </small>
                `;

                showNotification('‚úÖ Erfolgreich auf GitHub ver√∂ffentlicht!', 'success');

            } catch (error) {
                console.error('GitHub push error:', error);
                statusEl.className = 'alert alert-warning';
                statusEl.innerHTML = `
                    ‚ùå <strong>Fehler beim Ver√∂ffentlichen:</strong><br>
                    ${error.message}<br><br>
                    <small>
                        M√∂gliche Ursachen:<br>
                        ‚Ä¢ Token ung√ºltig oder abgelaufen<br>
                        ‚Ä¢ Token hat keine Schreibrechte f√ºr dieses Repo<br>
                        ‚Ä¢ Repository existiert nicht<br>
                        ‚Ä¢ Branch existiert nicht<br><br>
                        Fallback: Nutzen Sie "üíæ CSV herunterladen" und laden Sie manuell auf GitHub hoch.
                    </small>
                `;
                showNotification('‚ùå GitHub-Upload fehlgeschlagen - siehe Details', 'error');
            }
        }

        // Load config on startup
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
        });
    </script>
</body>
</html>
