<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Berechtigungs-Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .live-data {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <h1>üîç Windrad AR - Berechtigungs-Debug</h1>
    <p><strong>Zweck:</strong> √úberpr√ºfung aller Berechtigungen und Browser-APIs</p>

    <!-- HTTPS Check -->
    <div class="test-section">
        <h2>üîí HTTPS Check</h2>
        <div id="httpsStatus"></div>
    </div>

    <!-- Browser Check -->
    <div class="test-section">
        <h2>üåê Browser Information</h2>
        <div id="browserInfo"></div>
    </div>

    <!-- GPS/Geolocation -->
    <div class="test-section">
        <h2>üìç GPS / Geolocation</h2>
        <button onclick="testGeolocation()">GPS testen</button>
        <div id="gpsStatus"></div>
        <div id="gpsData"></div>
    </div>

    <!-- Kamera -->
    <div class="test-section">
        <h2>üì∏ Kamera</h2>
        <button onclick="testCamera()">Kamera testen</button>
        <button onclick="stopCamera()">Kamera stoppen</button>
        <div id="cameraStatus"></div>
        <video id="testVideo" autoplay playsinline style="max-width: 100%; border-radius: 8px; margin-top: 10px;"></video>
    </div>

    <!-- Kompass / DeviceOrientation -->
    <div class="test-section">
        <h2>üß≠ Kompass / DeviceOrientation</h2>
        <button onclick="testOrientation()">Kompass testen</button>
        <button onclick="stopOrientation()">Kompass stoppen</button>
        <div id="orientationStatus"></div>
        <div id="orientationData" class="live-data"></div>
    </div>

    <!-- MediaDevices Check -->
    <div class="test-section">
        <h2>üé• Verf√ºgbare Medienger√§te</h2>
        <button onclick="listDevices()">Ger√§te auflisten</button>
        <div id="devicesStatus"></div>
    </div>

    <!-- Permissions API -->
    <div class="test-section">
        <h2>üîê Permissions API Status</h2>
        <button onclick="checkPermissions()">Berechtigungen pr√ºfen</button>
        <div id="permissionsStatus"></div>
    </div>

    <script>
        let cameraStream = null;
        let orientationActive = false;

        // ========================================
        // HTTPS Check
        // ========================================
        function checkHTTPS() {
            const isHTTPS = window.location.protocol === 'https:';
            const isLocalhost = window.location.hostname === 'localhost' ||
                               window.location.hostname === '127.0.0.1';

            const status = document.getElementById('httpsStatus');
            if (isHTTPS || isLocalhost) {
                status.innerHTML = `<div class="status success">
                    ‚úÖ Sicherer Kontext: ${window.location.protocol}//${window.location.host}
                    ${isLocalhost ? '<br>‚ÑπÔ∏è Localhost erlaubt unsichere Verbindungen f√ºr Tests' : ''}
                </div>`;
            } else {
                status.innerHTML = `<div class="status error">
                    ‚ùå HTTPS erforderlich! Aktuell: ${window.location.protocol}
                    <br>‚ö†Ô∏è Kamera und Kompass funktionieren nur mit HTTPS oder localhost
                </div>`;
            }
        }

        // ========================================
        // Browser Info
        // ========================================
        function checkBrowser() {
            const info = document.getElementById('browserInfo');
            const data = {
                'User Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'Sprache': navigator.language,
                'Online': navigator.onLine,
                'Cookie aktiviert': navigator.cookieEnabled
            };

            let html = '<div class="status info">';
            for (const [key, value] of Object.entries(data)) {
                html += `<strong>${key}:</strong> ${value}<br>`;
            }
            html += '</div>';
            info.innerHTML = html;
        }

        // ========================================
        // GPS / Geolocation
        // ========================================
        async function testGeolocation() {
            const status = document.getElementById('gpsStatus');
            const data = document.getElementById('gpsData');

            if (!navigator.geolocation) {
                status.innerHTML = '<div class="status error">‚ùå Geolocation API nicht verf√ºgbar</div>';
                return;
            }

            status.innerHTML = '<div class="status warning">‚è≥ GPS-Position wird abgerufen...</div>';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    status.innerHTML = '<div class="status success">‚úÖ GPS erfolgreich abgerufen</div>';
                    data.innerHTML = `<pre>${JSON.stringify({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy + ' m',
                        altitude: position.coords.altitude,
                        speed: position.coords.speed,
                        heading: position.coords.heading,
                        timestamp: new Date(position.timestamp).toLocaleString()
                    }, null, 2)}</pre>`;
                },
                (error) => {
                    status.innerHTML = `<div class="status error">
                        ‚ùå GPS-Fehler: ${error.message}
                        <br><strong>Code:</strong> ${error.code}
                        <br><strong>M√∂gliche Ursachen:</strong>
                        <ul>
                            <li>Standortdienste deaktiviert</li>
                            <li>Berechtigung verweigert</li>
                            <li>Timeout (Ger√§t findet keine Position)</li>
                            <li>Position nicht verf√ºgbar</li>
                        </ul>
                    </div>`;
                    data.innerHTML = '';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // ========================================
        // Kamera
        // ========================================
        async function testCamera() {
            const status = document.getElementById('cameraStatus');
            const video = document.getElementById('testVideo');

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                status.innerHTML = '<div class="status error">‚ùå getUserMedia API nicht verf√ºgbar</div>';
                return;
            }

            status.innerHTML = '<div class="status warning">‚è≥ Kamera wird gestartet...</div>';

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });

                video.srcObject = cameraStream;
                video.style.display = 'block';

                const track = cameraStream.getVideoTracks()[0];
                const settings = track.getSettings();

                status.innerHTML = `<div class="status success">
                    ‚úÖ Kamera erfolgreich gestartet
                    <br><strong>Aufl√∂sung:</strong> ${settings.width} √ó ${settings.height}
                    <br><strong>Facing Mode:</strong> ${settings.facingMode}
                    <br><strong>Device ID:</strong> ${settings.deviceId}
                </div>`;

            } catch (error) {
                status.innerHTML = `<div class="status error">
                    ‚ùå Kamera-Fehler: ${error.name}
                    <br><strong>Message:</strong> ${error.message}
                    <br><strong>M√∂gliche Ursachen:</strong>
                    <ul>
                        <li><strong>NotAllowedError:</strong> Berechtigung verweigert</li>
                        <li><strong>NotFoundError:</strong> Keine Kamera gefunden</li>
                        <li><strong>NotReadableError:</strong> Kamera wird bereits verwendet</li>
                        <li><strong>OverconstrainedError:</strong> Anforderungen nicht erf√ºllbar</li>
                        <li><strong>SecurityError:</strong> HTTPS erforderlich</li>
                    </ul>
                </div>`;
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                document.getElementById('testVideo').style.display = 'none';
                document.getElementById('cameraStatus').innerHTML = '<div class="status info">‚ÑπÔ∏è Kamera gestoppt</div>';
            }
        }

        // ========================================
        // Kompass / DeviceOrientation
        // ========================================
        async function testOrientation() {
            const status = document.getElementById('orientationStatus');
            const data = document.getElementById('orientationData');

            // Check if iOS and needs permission
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {

                status.innerHTML = '<div class="status warning">‚è≥ iOS-Berechtigung wird angefordert...</div>';

                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        status.innerHTML = '<div class="status error">‚ùå DeviceOrientation-Berechtigung verweigert</div>';
                        return;
                    }
                    status.innerHTML = '<div class="status success">‚úÖ iOS-Berechtigung erteilt</div>';
                } catch (error) {
                    status.innerHTML = `<div class="status error">
                        ‚ùå Berechtigungs-Fehler: ${error.message}
                        <br>‚ö†Ô∏è iOS erfordert HTTPS und User-Interaktion (Button-Klick)
                    </div>`;
                    return;
                }
            } else if (typeof DeviceOrientationEvent === 'undefined') {
                status.innerHTML = '<div class="status error">‚ùå DeviceOrientationEvent nicht verf√ºgbar</div>';
                return;
            } else {
                status.innerHTML = '<div class="status success">‚úÖ DeviceOrientation verf√ºgbar (keine Berechtigung n√∂tig)</div>';
            }

            // Start listening
            orientationActive = true;

            const handleOrientation = (event) => {
                if (!orientationActive) return;

                let heading = null;
                let source = '';

                // iOS uses webkitCompassHeading
                if (event.webkitCompassHeading !== undefined && event.webkitCompassHeading !== null) {
                    heading = event.webkitCompassHeading;
                    source = 'iOS webkitCompassHeading';
                }
                // Android uses alpha (inverted)
                else if (event.alpha !== null) {
                    heading = 360 - event.alpha;
                    source = 'Android alpha (invertiert)';
                }

                data.innerHTML = `
                    <strong>Kompass-Daten (Live):</strong><br>
                    Richtung: ${heading !== null ? Math.round(heading) + '¬∞' : 'Nicht verf√ºgbar'}<br>
                    Quelle: ${source || 'Keine'}<br>
                    <br>
                    <strong>Rohdaten:</strong><br>
                    alpha: ${event.alpha !== null ? event.alpha.toFixed(2) + '¬∞' : 'null'}<br>
                    beta: ${event.beta !== null ? event.beta.toFixed(2) + '¬∞' : 'null'}<br>
                    gamma: ${event.gamma !== null ? event.gamma.toFixed(2) + '¬∞' : 'null'}<br>
                    webkitCompassHeading: ${event.webkitCompassHeading !== undefined ? event.webkitCompassHeading + '¬∞' : 'undefined'}<br>
                    absolute: ${event.absolute}
                `;
            };

            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('deviceorientationabsolute', handleOrientation);

            // Store handler for cleanup
            window._orientationHandler = handleOrientation;
        }

        function stopOrientation() {
            orientationActive = false;
            if (window._orientationHandler) {
                window.removeEventListener('deviceorientation', window._orientationHandler);
                window.removeEventListener('deviceorientationabsolute', window._orientationHandler);
            }
            document.getElementById('orientationStatus').innerHTML = '<div class="status info">‚ÑπÔ∏è Kompass gestoppt</div>';
            document.getElementById('orientationData').innerHTML = '';
        }

        // ========================================
        // MediaDevices List
        // ========================================
        async function listDevices() {
            const status = document.getElementById('devicesStatus');

            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                status.innerHTML = '<div class="status error">‚ùå enumerateDevices nicht verf√ºgbar</div>';
                return;
            }

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();

                const videoInputs = devices.filter(d => d.kind === 'videoinput');
                const audioInputs = devices.filter(d => d.kind === 'audioinput');
                const audioOutputs = devices.filter(d => d.kind === 'audiooutput');

                let html = '<div class="status success">‚úÖ Ger√§te gefunden</div>';
                html += '<pre>';
                html += `<strong>Video-Eing√§nge (${videoInputs.length}):</strong>\n`;
                videoInputs.forEach((d, i) => {
                    html += `  ${i+1}. ${d.label || 'Kamera ' + (i+1)}\n`;
                    html += `     ID: ${d.deviceId}\n`;
                });
                html += `\n<strong>Audio-Eing√§nge (${audioInputs.length}):</strong>\n`;
                audioInputs.forEach((d, i) => {
                    html += `  ${i+1}. ${d.label || 'Mikrofon ' + (i+1)}\n`;
                });
                html += `\n<strong>Audio-Ausg√§nge (${audioOutputs.length}):</strong>\n`;
                audioOutputs.forEach((d, i) => {
                    html += `  ${i+1}. ${d.label || 'Lautsprecher ' + (i+1)}\n`;
                });
                html += '</pre>';

                status.innerHTML = html;

            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå Fehler: ${error.message}</div>`;
            }
        }

        // ========================================
        // Permissions API
        // ========================================
        async function checkPermissions() {
            const status = document.getElementById('permissionsStatus');

            if (!navigator.permissions) {
                status.innerHTML = '<div class="status warning">‚ö†Ô∏è Permissions API nicht verf√ºgbar</div>';
                return;
            }

            const permissions = ['camera', 'geolocation'];
            let html = '<div class="status info">';

            for (const perm of permissions) {
                try {
                    const result = await navigator.permissions.query({ name: perm });
                    const icon = result.state === 'granted' ? '‚úÖ' : result.state === 'denied' ? '‚ùå' : '‚ö†Ô∏è';
                    html += `${icon} <strong>${perm}:</strong> ${result.state}<br>`;
                } catch (error) {
                    html += `‚ùì <strong>${perm}:</strong> Nicht abfragbar (${error.message})<br>`;
                }
            }

            html += '</div>';
            status.innerHTML = html;
        }

        // ========================================
        // Initialize on load
        // ========================================
        window.addEventListener('load', () => {
            checkHTTPS();
            checkBrowser();
        });
    </script>
</body>
</html>
