<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Windrad AR mit Brandenburg DOM - Neuhausen/Spree</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1>üå¨Ô∏è Windrad AR Visualisierung</h1>
            <p>Mit Brandenburg Oberfl√§chenmodell - Neuhausen/Spree</p>
        </div>
    </div>

    <!-- Map Section -->
    <div class="map-section">
        <div id="map"></div>
        <div class="map-info">
            <div class="info-grid">
                <div class="info-item">
                    <strong>Entfernung</strong>
                    <span id="distanceDisplay">-</span>
                </div>
                <div class="info-item">
                    <strong>Richtung</strong>
                    <span id="directionDisplay">-</span>
                </div>
                <div class="info-item">
                    <strong>Nabenh√∂he</strong>
                    <span id="hubHeightDisplay">-</span>
                </div>
                <div class="info-item">
                    <strong>Rotordurchmesser</strong>
                    <span id="rotorDiameterDisplay">-</span>
                </div>
            </div>
            
            <div id="visibilityInfo" class="visibility-info" style="display: none;">
                <h4>üìä Sichtbarkeitsanalyse (Brandenburg DOM)</h4>
                <div class="visibility-details">
                    <div id="visibilityStatus"></div>
                    <div id="visibilityPercentage"></div>
                    <div id="visibilityObstacle"></div>
                </div>
            </div>
            
            <div id="elevationProfile" class="elevation-profile" style="display: none;">
                <h4 style="margin-bottom: 0.5rem;">üìà H√∂henprofil (mit Vegetation & Geb√§uden)</h4>
                <canvas id="elevationCanvas"></canvas>
            </div>
            
            <button class="btn btn-primary" id="photoBtn" disabled>
                üì∏ Foto aufnehmen
            </button>
        </div>
    </div>

    <!-- Turbine List -->
    <div class="map-section">
        <div class="turbine-list" id="turbineList">
            <p style="color: #666; text-align: center;">Lade Windr√§der...</p>
        </div>
    </div>

    <!-- Camera View -->
    <div class="camera-view" id="cameraView">
        <video id="cameraPreview" autoplay playsinline></video>
        <div class="camera-overlay">
            <div class="direction-indicator" id="directionIndicator">
                <span class="direction-arrow" id="directionArrow">üß≠</span>
                <span id="directionText">Windrad suchen...</span>
            </div>
            <div class="compass-display" id="compassDisplay">
                Kompass: --¬∞
            </div>
            <div class="debug-info" id="debugInfo">
                Kompass: --¬∞<br>
                Ziel: --¬∞<br>
                Differenz: --¬∞
            </div>
        </div>
        <div class="camera-controls">
            <button class="camera-btn camera-btn-capture" id="captureBtn">
                üì∏ Aufnehmen
            </button>
            <button class="camera-btn camera-btn-close" id="closeBtn">
                ‚úï Schlie√üen
            </button>
        </div>
    </div>

    <!-- Result Canvas (Hidden) -->
    <canvas id="resultCanvas" style="display: none;"></canvas>

    <!-- Photo Result View -->
    <div class="photo-result" id="photoResult">
        <div class="result-header">
            <h2>üì∑ Ihr Foto mit Windrad</h2>
        </div>

        <div class="result-image-container">
            <img id="resultImage" src="" alt="Windrad Foto" />
        </div>

        <div class="result-controls">
            <button class="btn btn-primary" onclick="downloadPhoto()">
                üíæ Foto speichern
            </button>
            <button class="btn btn-ai" onclick="enhanceWithAI()" id="aiEnhanceBtn">
                ü§ñ KI-Analyse verwenden
            </button>
            <button class="btn btn-secondary" onclick="sharePhoto()">
                üì§ Teilen
            </button>
            <button class="btn btn-secondary" onclick="closePhotoResult()">
                ‚úï Schlie√üen
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Analysiere Gel√§nde...</div>
        <div class="loading-subtext">Brandenburg Oberfl√§chenmodell (DOM)</div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Application JS -->
    <script src="js/config.js"></script>
    <script src="js/elevation-service.js"></script>
    <script src="js/visibility-calculator.js"></script>
    <script src="js/map-manager.js"></script>
    <script src="js/windrad-renderer.js"></script>
    <script src="js/camera-controller.js"></script>
    <script src="js/app.js"></script>

    <!-- Photo Result Functions -->
    <script>
        function downloadPhoto() {
            if (!window.currentPhotoData || !window.currentPhotoFilename) {
                alert('Kein Foto verf√ºgbar');
                return;
            }

            const link = document.createElement('a');
            link.download = window.currentPhotoFilename;
            link.href = window.currentPhotoData;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log('Photo download triggered');
        }

        async function sharePhoto() {
            if (!window.currentPhotoData || !window.currentPhotoFilename) {
                alert('Kein Foto verf√ºgbar');
                return;
            }

            // Check if Web Share API is available
            if (navigator.share && navigator.canShare) {
                try {
                    // Convert data URL to blob
                    const response = await fetch(window.currentPhotoData);
                    const blob = await response.blob();
                    const file = new File([blob], window.currentPhotoFilename, { type: 'image/jpeg' });

                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'Windrad AR Foto',
                            text: 'Foto von Windrad AR Visualisierung'
                        });
                        console.log('Photo shared successfully');
                    } else {
                        // Fallback to download if can't share files
                        downloadPhoto();
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Share error:', err);
                        alert('Teilen fehlgeschlagen. Verwenden Sie stattdessen "Foto speichern".');
                    }
                }
            } else {
                // Fallback to download
                alert('Teilen wird nicht unterst√ºtzt. Foto wird heruntergeladen.');
                downloadPhoto();
            }
        }

        /**
         * Re-render photo using AI scene analysis data
         */
        async function rerenderWithAIData(originalPhotoData, sceneData, turbine, userLocation) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');

                    // Draw original photo
                    ctx.drawImage(img, 0, 0);

                    // Create AI-enhanced orientation data
                    const aiOrientationData = {
                        deviceHeading: 0, // Not used when AI provides position
                        devicePitch: sceneData.horizon?.cameraPitch || 0,
                        targetBearing: 0, // Not used when AI provides position
                        cameraHeight: userLocation.altitude || 1.8,
                        // AI-specific overrides
                        aiPosition: {
                            x: sceneData.turbinePosition?.x || 0.5,
                            y: sceneData.turbinePosition?.y || 0.5,
                            sizePercent: sceneData.turbinePosition?.sizePercent || 0.15,
                            opacity: (sceneData.turbinePosition?.opacity || 85) / 100
                        },
                        aiOcclusion: sceneData.occlusion
                    };

                    // Get renderer and visibility data
                    const renderer = new WindradRenderer();
                    const visibilityData = window.lastVisibilityData || null;
                    renderer.setVisibilityData(visibilityData);

                    // Draw turbine with AI-enhanced positioning
                    renderer.drawWindrad(
                        ctx,
                        canvas.width,
                        canvas.height,
                        turbine,
                        userLocation,
                        aiOrientationData
                    );

                    // Return enhanced image
                    resolve(canvas.toDataURL('image/jpeg', 0.95));
                };
                img.src = originalPhotoData;
            });
        }

        async function enhanceWithAI() {
            if (!window.currentPhotoData) {
                alert('Kein Foto verf√ºgbar');
                return;
            }

            const btn = document.getElementById('aiEnhanceBtn');
            const originalText = btn.textContent;

            try {
                // Show loading state
                btn.disabled = true;
                btn.classList.add('loading');
                btn.textContent = 'ü§ñ KI analysiert...';

                // Get turbine and location data from saved metadata or global variables
                const metadata = window.currentPhotoMetadata || {};
                const turbine = metadata.turbine || window.selectedTurbine;
                const userLocation = metadata.userLocation || window.userLocation;

                if (!turbine || !userLocation) {
                    alert('Turbinen- oder Standortdaten fehlen.\n\n' +
                          'Bitte erst ein Foto aufnehmen bevor Sie die KI-Analyse verwenden.');
                    return;
                }

                // Prepare metadata for AI
                const apiMetadata = {
                    turbine: {
                        name: turbine.name,
                        lat: turbine.lat,
                        lon: turbine.lon,
                        hubHeight: turbine.hubHeight,
                        rotorDiameter: turbine.rotorDiameter,
                        totalHeight: turbine.hubHeight + (turbine.rotorDiameter / 2)
                    },
                    camera: {
                        lat: userLocation.lat,
                        lng: userLocation.lng,
                        altitude: userLocation.altitude || 1.8,
                        distance: calcDistance(userLocation.lat, userLocation.lng, turbine.lat, turbine.lon) * 1000
                    },
                    instructions: `Analyze this photo and add a realistic wind turbine visualization at the correct position.
                        The turbine is ${turbine.hubHeight + (turbine.rotorDiameter / 2)}m tall and ${calcDistance(userLocation.lat, userLocation.lng, turbine.lat, turbine.lon) * 1000}m away.
                        Consider perspective, occlusion by buildings/trees, and proper scaling.`
                };

                // Call AI API endpoint (Cloudflare Worker with Claude Vision)
                const response = await fetch('https://windrad-ai-worker.pischdi.workers.dev/api/enhance-photo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image: window.currentPhotoData,
                        metadata: apiMetadata
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.sceneData) {
                    console.log('Claude scene analysis:', result.sceneData);

                    // Re-render photo using AI scene data
                    const enhancedPhoto = await rerenderWithAIData(
                        window.currentPhotoData,
                        result.sceneData,
                        turbine,
                        userLocation
                    );

                    // Update display
                    const resultImage = document.getElementById('resultImage');
                    resultImage.src = enhancedPhoto;
                    window.currentPhotoData = enhancedPhoto;

                    // Show success message with confidence
                    const confidence = result.sceneData.confidence || 0;
                    alert(`‚úÖ KI-Analyse abgeschlossen!\n\n` +
                          `Vertrauen: ${(confidence * 100).toFixed(0)}%\n` +
                          `Erkannte Objekte: ${result.sceneData.foregroundObjects?.length || 0}\n\n` +
                          `Foto wurde mit Claude Vision-Daten neu gerendert.`);

                    console.log('Photo enhanced with AI successfully');
                } else {
                    throw new Error('Invalid AI response');
                }

            } catch (error) {
                console.error('AI enhancement error:', error);

                let errorMessage = 'KI-Analyse fehlgeschlagen.\n\n';

                if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'Verbindung zum KI-Worker fehlgeschlagen.\n' +
                                  'Bitte √ºberpr√ºfen Sie Ihre Internetverbindung.';
                } else if (error.message.includes('API Error: 401')) {
                    errorMessage += 'API-Authentifizierung fehlgeschlagen.\n' +
                                  'Der Claude API Key muss √ºberpr√ºft werden.';
                } else if (error.message.includes('API Error: 429')) {
                    errorMessage += 'Zu viele Anfragen.\n' +
                                  'Bitte warten Sie einen Moment und versuchen Sie es erneut.';
                } else {
                    errorMessage += error.message;
                }

                alert(errorMessage);
            } finally {
                // Reset button state
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.textContent = originalText;
            }
        }

        function closePhotoResult() {
            const photoResult = document.getElementById('photoResult');
            if (photoResult) {
                photoResult.classList.remove('active');
            }

            // Clear photo data
            window.currentPhotoData = null;
            window.currentPhotoFilename = null;
            window.currentPhotoMetadata = null;
        }
    </script>
</body>
</html>
