<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kompass Test - Debug</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 1rem;
        }
        
        .test-box {
            background: #111;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        h1 {
            color: #0ff;
            margin-bottom: 1rem;
        }
        
        h2 {
            color: #ff0;
            margin-bottom: 0.5rem;
        }
        
        .btn {
            background: #0f0;
            color: #000;
            border: none;
            padding: 1rem;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        .btn:active {
            background: #0a0;
        }
        
        .status {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #222;
            border-left: 3px solid #0f0;
        }
        
        .status.error {
            border-color: #f00;
            color: #f00;
        }
        
        .status.warning {
            border-color: #ff0;
            color: #ff0;
        }
        
        .big-compass {
            text-align: center;
            font-size: 4rem;
            font-weight: bold;
            padding: 2rem;
            background: #222;
            border-radius: 12px;
            margin: 1rem 0;
        }
        
        .compass-value {
            font-size: 2rem;
            color: #0ff;
        }
    </style>
</head>
<body>
    <h1>üß≠ KOMPASS TEST</h1>
    
    <div class="test-box">
        <h2>1. Browser-Info</h2>
        <div class="status" id="browserInfo">Lade...</div>
        <div class="status" id="httpsInfo">Lade...</div>
    </div>
    
    <div class="test-box">
        <h2>2. Sensor-Verf√ºgbarkeit</h2>
        <div class="status" id="sensorInfo">Pr√ºfe...</div>
        <div class="status" id="permissionInfo">Pr√ºfe...</div>
    </div>
    
    <div class="test-box">
        <h2>3. Kompass aktivieren</h2>
        <button class="btn" onclick="startCompass()">üß≠ KOMPASS STARTEN</button>
        <div id="compassStatus"></div>
    </div>
    
    <div class="test-box">
        <h2>4. Live-Werte</h2>
        <div class="big-compass">
            <div id="compassDisplay">--</div>
            <div class="compass-value" id="compassDegrees">0¬∞</div>
        </div>
        <div class="status" id="alphaValue">alpha: --</div>
        <div class="status" id="betaValue">beta: --</div>
        <div class="status" id="gammaValue">gamma: --</div>
        <div class="status" id="webkitValue">webkitCompassHeading: --</div>
        <div class="status" id="absoluteValue">absolute: --</div>
    </div>
    
    <div class="test-box">
        <h2>5. Event-Log (letzte 10)</h2>
        <div id="eventLog"></div>
    </div>
    
    <script>
        const eventLog = [];
        let compassActive = false;
        
        function log(msg, type = 'info') {
            console.log(msg);
            eventLog.push({ time: new Date().toLocaleTimeString(), msg: msg, type: type });
            if (eventLog.length > 10) eventLog.shift();
            updateEventLog();
        }
        
        function updateEventLog() {
            const logDiv = document.getElementById('eventLog');
            logDiv.innerHTML = eventLog.map(e => 
                `<div class="status ${e.type}">[${e.time}] ${e.msg}</div>`
            ).join('');
        }
        
        // Check browser info
        const userAgent = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent);
        const isAndroid = /Android/.test(userAgent);
        const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
        const isChrome = /Chrome/.test(userAgent);
        const isFirefox = /Firefox/.test(userAgent);
        const isSecure = window.location.protocol === 'https:';
        
        document.getElementById('browserInfo').textContent = 
            `Browser: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'} | ` +
            `${isSafari ? 'Safari' : isChrome ? 'Chrome' : isFirefox ? 'Firefox' : 'Unbekannt'}`;
        
        document.getElementById('httpsInfo').textContent = 
            `HTTPS: ${isSecure ? '‚úÖ Ja' : '‚ùå NEIN (Kompass braucht HTTPS!)'}`;
        document.getElementById('httpsInfo').className = isSecure ? 'status' : 'status error';
        
        // Check sensor availability
        if (typeof DeviceOrientationEvent !== 'undefined') {
            document.getElementById('sensorInfo').textContent = 
                '‚úÖ DeviceOrientationEvent verf√ºgbar';
            log('DeviceOrientationEvent gefunden', 'info');
        } else {
            document.getElementById('sensorInfo').textContent = 
                '‚ùå DeviceOrientationEvent NICHT verf√ºgbar';
            document.getElementById('sensorInfo').className = 'status error';
            log('DeviceOrientationEvent fehlt!', 'error');
        }
        
        // Check permission API
        if (typeof DeviceOrientationEvent !== 'undefined' && 
            typeof DeviceOrientationEvent.requestPermission === 'function') {
            document.getElementById('permissionInfo').textContent = 
                '‚úÖ Berechtigung kann angefragt werden (iOS 13+)';
            log('requestPermission() verf√ºgbar', 'info');
        } else {
            document.getElementById('permissionInfo').textContent = 
                '‚ö†Ô∏è Keine explizite Berechtigung n√∂tig (Android/Desktop)';
            document.getElementById('permissionInfo').className = 'status warning';
            log('requestPermission() nicht verf√ºgbar', 'warning');
        }
        
        // Start compass
        async function startCompass() {
            const statusDiv = document.getElementById('compassStatus');
            statusDiv.innerHTML = '<div class="status">Starte Kompass...</div>';
            log('Kompass-Start angefordert', 'info');
            
            try {
                // iOS 13+ requires permission
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    
                    log('Frage nach Berechtigung (iOS)...', 'info');
                    const permission = await DeviceOrientationEvent.requestPermission();
                    log(`Berechtigung: ${permission}`, permission === 'granted' ? 'info' : 'error');
                    
                    if (permission === 'granted') {
                        // Try deviceorientation first
                        window.addEventListener('deviceorientation', handleOrientation, true);
                        log('Event-Listener registriert (deviceorientation)', 'info');
                        statusDiv.innerHTML = '<div class="status">‚úÖ Kompass l√§uft! Bewegen Sie das Ger√§t...</div>';
                        compassActive = true;
                    } else {
                        statusDiv.innerHTML = '<div class="status error">‚ùå Berechtigung verweigert!</div>';
                        log('Berechtigung verweigert', 'error');
                    }
                } else {
                    // Android/Desktop - try both event types
                    log('Registriere Event-Listener (kein iOS)...', 'info');
                    
                    // Try absolute first
                    if ('ondeviceorientationabsolute' in window) {
                        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                        log('Event-Listener: deviceorientationabsolute', 'info');
                    } else {
                        window.addEventListener('deviceorientation', handleOrientation, true);
                        log('Event-Listener: deviceorientation', 'info');
                    }
                    
                    statusDiv.innerHTML = '<div class="status">‚úÖ Kompass l√§uft! Bewegen Sie das Ger√§t...</div>';
                    compassActive = true;
                }
            } catch (error) {
                log(`FEHLER: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="status error">‚ùå Fehler: ${error.message}</div>`;
            }
        }
        
        // Handle orientation
        let eventCount = 0;
        function handleOrientation(event) {
            eventCount++;
            
            // Log every 30th event to avoid spam
            if (eventCount % 30 === 0) {
                log(`Event #${eventCount} empfangen`, 'info');
            }
            
            // Update all values
            document.getElementById('alphaValue').textContent = 
                `alpha: ${event.alpha !== null ? event.alpha.toFixed(1) : 'null'}`;
            document.getElementById('betaValue').textContent = 
                `beta: ${event.beta !== null ? event.beta.toFixed(1) : 'null'}`;
            document.getElementById('gammaValue').textContent = 
                `gamma: ${event.gamma !== null ? event.gamma.toFixed(1) : 'null'}`;
            document.getElementById('webkitValue').textContent = 
                `webkitCompassHeading: ${event.webkitCompassHeading !== undefined ? event.webkitCompassHeading.toFixed(1) : 'undefined'}`;
            document.getElementById('absoluteValue').textContent = 
                `absolute: ${event.absolute ? 'true' : 'false'}`;
            
            // Calculate compass heading
            let heading = 0;
            let source = '';
            
            if (event.webkitCompassHeading !== undefined && event.webkitCompassHeading !== null) {
                heading = event.webkitCompassHeading;
                source = 'webkit';
            } else if (event.alpha !== null) {
                heading = 360 - event.alpha;
                source = 'alpha';
            }
            
            // Update display
            const directions = ['N', 'NO', 'O', 'SO', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(heading / 45) % 8;
            
            document.getElementById('compassDisplay').textContent = directions[index];
            document.getElementById('compassDegrees').textContent = Math.round(heading) + '¬∞';
            
            // Color based on source
            const display = document.getElementById('compassDisplay');
            if (source === 'webkit') {
                display.style.color = '#0f0'; // Green = good (webkit)
            } else if (source === 'alpha') {
                display.style.color = '#ff0'; // Yellow = okay (alpha)
            } else {
                display.style.color = '#f00'; // Red = bad
            }
            
            // Log source on first event
            if (eventCount === 1) {
                log(`Datenquelle: ${source || 'keine'}`, source ? 'info' : 'error');
            }
        }
        
        // Auto-start on mobile
        if ((isIOS || isAndroid) && isSecure) {
            log('Mobile + HTTPS erkannt - bereit zum Starten', 'info');
        }
    </script>
</body>
</html>
