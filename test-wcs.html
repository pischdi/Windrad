<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Brandenburg WCS Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #4caf50; }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        button:hover { background: #1976d2; }
        button:disabled { background: #666; cursor: not-allowed; }
        .result {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
        input {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
            width: 150px;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Brandenburg WCS Test</h1>
    <p>Test ob Brandenburg Digitales Oberfl√§chenmodell (DOM) WCS-Abfragen unterst√ºtzt</p>

    <!-- Test 1: WCS GetCapabilities -->
    <div class="test-section">
        <h2>Test 1: WCS GetCapabilities</h2>
        <p>Pr√ºft welche Coverage-Layers verf√ºgbar sind</p>
        <button onclick="testGetCapabilities()">GetCapabilities testen</button>
        <div id="result1" class="result"></div>
    </div>

    <!-- Test 2: WCS DescribeCoverage -->
    <div class="test-section">
        <h2>Test 2: WCS DescribeCoverage</h2>
        <p>Beschreibt das DOM Coverage Layer</p>
        <input type="text" id="coverageName" placeholder="Coverage Name" value="dom">
        <button onclick="testDescribeCoverage()">DescribeCoverage testen</button>
        <div id="result2" class="result"></div>
    </div>

    <!-- Test 3: WCS GetCoverage (Point) -->
    <div class="test-section">
        <h2>Test 3: WCS GetCoverage (Punkt)</h2>
        <p>Holt H√∂hendaten f√ºr einen Punkt in Neuhausen/Spree</p>
        <label>Latitude: <input type="number" id="lat" value="51.6724" step="0.0001"></label>
        <label>Longitude: <input type="number" id="lon" value="14.4354" step="0.0001"></label>
        <button onclick="testGetCoverage()">GetCoverage testen</button>
        <div id="result3" class="result"></div>
    </div>

    <!-- Test 4: Alternative WMS GetFeatureInfo -->
    <div class="test-section">
        <h2>Test 4: WMS GetFeatureInfo (Alternative)</h2>
        <p>Versucht H√∂hendaten √ºber WMS GetFeatureInfo zu bekommen</p>
        <button onclick="testWMSGetFeatureInfo()">WMS GetFeatureInfo testen</button>
        <div id="result4" class="result"></div>
    </div>

    <!-- Test 5: Geodatenportal Brandenburg -->
    <div class="test-section">
        <h2>Test 5: Brandenburg Geoportal APIs</h2>
        <p>Liste bekannter Brandenburg Geodaten-Endpoints</p>
        <button onclick="showEndpoints()">Endpoints anzeigen</button>
        <div id="result5" class="result"></div>
    </div>

    <script>
        const log = (elementId, message, type = 'info') => {
            const el = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            el.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
        };

        const clear = (elementId) => {
            document.getElementById(elementId).innerHTML = '';
        };

        // Test 1: WCS GetCapabilities
        async function testGetCapabilities() {
            clear('result1');
            log('result1', 'Starte WCS GetCapabilities Test...', 'info');

            const endpoints = [
                'https://isk.geobasis-bb.de/mapproxy/dop20c/service',
                'https://isk.geobasis-bb.de/ows/dom_wcs',
                'https://geodaten.brandenburg.de/services/dom',
                'https://geobroker.geobasis-bb.de/gbss.php'
            ];

            for (const endpoint of endpoints) {
                try {
                    log('result1', `Teste: ${endpoint}`, 'info');

                    const url = `${endpoint}?SERVICE=WCS&VERSION=2.0.1&REQUEST=GetCapabilities`;

                    log('result1', `URL: ${url}`, 'info');

                    const response = await fetch(url, { mode: 'cors' });

                    if (response.ok) {
                        const text = await response.text();
                        log('result1', `‚úÖ SUCCESS! Status: ${response.status}`, 'success');
                        log('result1', `Content-Type: ${response.headers.get('content-type')}`, 'info');
                        log('result1', `Response length: ${text.length} bytes`, 'info');
                        log('result1', `First 500 chars:\n${text.substring(0, 500)}`, 'info');
                        return;
                    } else {
                        log('result1', `‚ùå HTTP ${response.status}: ${response.statusText}`, 'error');
                    }
                } catch (error) {
                    log('result1', `‚ùå Error: ${error.message}`, 'error');
                    if (error.message.includes('CORS')) {
                        log('result1', '‚ö†Ô∏è CORS blockiert - Backend-Proxy n√∂tig!', 'warning');
                    }
                }
            }

            log('result1', '\n‚ùå Kein Endpoint funktioniert direkt vom Browser', 'error');
        }

        // Test 2: WCS DescribeCoverage
        async function testDescribeCoverage() {
            clear('result2');
            log('result2', 'Starte WCS DescribeCoverage Test...', 'info');

            const coverageName = document.getElementById('coverageName').value;
            const endpoint = 'https://isk.geobasis-bb.de/ows/dom_wcs';

            try {
                const url = `${endpoint}?SERVICE=WCS&VERSION=2.0.1&REQUEST=DescribeCoverage&COVERAGEID=${coverageName}`;
                log('result2', `URL: ${url}`, 'info');

                const response = await fetch(url, { mode: 'cors' });

                if (response.ok) {
                    const text = await response.text();
                    log('result2', '‚úÖ SUCCESS!', 'success');
                    log('result2', text, 'info');
                } else {
                    log('result2', `‚ùå HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                log('result2', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Test 3: WCS GetCoverage
        async function testGetCoverage() {
            clear('result3');
            log('result3', 'Starte WCS GetCoverage Test...', 'info');

            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);

            log('result3', `Koordinaten: ${lat}, ${lon}`, 'info');

            // Convert WGS84 to ETRS89/UTM33N (EPSG:25833)
            const utm = convertToUTM(lat, lon);
            log('result3', `UTM (EPSG:25833): ${utm.x.toFixed(2)}, ${utm.y.toFixed(2)}`, 'info');

            const endpoint = 'https://isk.geobasis-bb.de/ows/dom_wcs';

            // Try GetCoverage for a small bbox around the point
            const buffer = 10; // 10 meter buffer
            const bbox = `${utm.x - buffer},${utm.y - buffer},${utm.x + buffer},${utm.y + buffer}`;

            try {
                const url = `${endpoint}?SERVICE=WCS&VERSION=2.0.1&REQUEST=GetCoverage&COVERAGEID=dom&SUBSET=X(${utm.x - buffer},${utm.x + buffer})&SUBSET=Y(${utm.y - buffer},${utm.y + buffer})&FORMAT=image/tiff`;

                log('result3', `URL: ${url}`, 'info');

                const response = await fetch(url, { mode: 'cors' });

                if (response.ok) {
                    const blob = await response.blob();
                    log('result3', '‚úÖ SUCCESS! Received data', 'success');
                    log('result3', `Type: ${blob.type}`, 'info');
                    log('result3', `Size: ${blob.size} bytes`, 'info');

                    // Try to parse if it's GeoTIFF
                    log('result3', '‚ö†Ô∏è Erhaltenes GeoTIFF m√ºsste mit georaster gelesen werden', 'warning');
                } else {
                    log('result3', `‚ùå HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                log('result3', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Test 4: WMS GetFeatureInfo
        async function testWMSGetFeatureInfo() {
            clear('result4');
            log('result4', 'Starte WMS GetFeatureInfo Test...', 'info');

            const lat = 51.6724;
            const lon = 14.4354;

            const endpoint = 'https://isk.geobasis-bb.de/mapproxy/dop20c/service/wms';

            // WMS GetFeatureInfo parameters
            const params = new URLSearchParams({
                SERVICE: 'WMS',
                VERSION: '1.3.0',
                REQUEST: 'GetFeatureInfo',
                LAYERS: 'by_dop20c',
                QUERY_LAYERS: 'by_dop20c',
                CRS: 'EPSG:4326',
                BBOX: `${lon - 0.01},${lat - 0.01},${lon + 0.01},${lat + 0.01}`,
                WIDTH: 101,
                HEIGHT: 101,
                I: 50,
                J: 50,
                INFO_FORMAT: 'application/json'
            });

            try {
                const url = `${endpoint}?${params}`;
                log('result4', `URL: ${url.substring(0, 100)}...`, 'info');

                const response = await fetch(url, { mode: 'cors' });

                if (response.ok) {
                    const text = await response.text();
                    log('result4', '‚úÖ Response erhalten:', 'success');
                    log('result4', text, 'info');
                } else {
                    log('result4', `‚ùå HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                log('result4', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Test 5: Show known endpoints
        function showEndpoints() {
            clear('result5');
            log('result5', '=== Brandenburg Geodaten Endpoints ===\n', 'success');

            const endpoints = {
                'WMS (Luftbilder)': 'https://isk.geobasis-bb.de/mapproxy/dop20c/service/wms',
                'WCS (DOM)': 'https://isk.geobasis-bb.de/ows/dom_wcs (unbest√§tigt)',
                'GeoPortal': 'https://geoportal.brandenburg.de',
                'Metadaten': 'https://metaver.de',
                'Download': 'https://data.geobasis-bb.de',
                'INSPIRE': 'https://isk.geobasis-bb.de/inspire'
            };

            for (const [name, url] of Object.entries(endpoints)) {
                log('result5', `${name}:\n  ${url}\n`, 'info');
            }

            log('result5', '\nüìö Dokumentation:', 'warning');
            log('result5', 'https://geobroker.geobasis-bb.de/', 'info');
            log('result5', 'https://geoportal.brandenburg.de/geodaten/', 'info');
        }

        // Simple WGS84 to UTM33N conversion (approximation)
        function convertToUTM(lat, lng) {
            // Simplified conversion for Brandenburg region
            // For production, use proj4js library

            const zone = 33;
            const lambda0 = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180;

            const phi = lat * Math.PI / 180;
            const lambda = lng * Math.PI / 180;

            const N = 6378137 / Math.sqrt(1 - 0.00669438 * Math.sin(phi) * Math.sin(phi));
            const T = Math.tan(phi) * Math.tan(phi);
            const C = 0.00673949675 * Math.cos(phi) * Math.cos(phi);
            const A = (lambda - lambda0) * Math.cos(phi);

            const M = 6378137 * ((1 - 0.00669438/4 - 3*0.00669438*0.00669438/64) * phi);

            const x = 0.9996 * N * (A + (1-T+C)*A*A*A/6) + 500000;
            const y = 0.9996 * M;

            return { x, y };
        }

        // Info on page load
        window.addEventListener('load', () => {
            console.log('Brandenburg WCS Test geladen');
            console.log('Teste verschiedene Endpoints um WCS-Zugriff zu validieren');
        });
    </script>
</body>
</html>
